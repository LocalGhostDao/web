<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Countdown | LocalGhost.ai</title>
    <meta name="title" content="Countdown | LocalGhost.ai">
    <meta name="description" content="Countdown timer with fireworks or apocalypse. Your choice. Share custom countdowns with friends.">
    <meta name="keywords" content="countdown, new year, timer, celebration, LocalGhost">
    <meta name="author" content="LocalGhost">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://www.localghost.ai/countdown">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.localghost.ai/countdown">
    <meta property="og:title" content="Countdown | LocalGhost.ai">
    <meta property="og:description" content="Countdown timer with fireworks or apocalypse. Your choice.">
    <meta property="og:image" content="https://www.localghost.ai/images/og-countdown.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="LocalGhost.ai">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.localghost.ai/countdown">
    <meta name="twitter:title" content="Countdown | LocalGhost.ai">
    <meta name="twitter:description" content="Countdown timer with fireworks or apocalypse. Your choice.">
    <meta name="twitter:image" content="https://www.localghost.ai/images/og-countdown.png">
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico" sizes="48x48 32x32 16x16">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="48x48" href="/images/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#111111">
    <meta name="msapplication-TileColor" content="#111111">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "LocalGhost Countdown",
        "description": "Shareable countdown timer with celebration effects",
        "url": "https://www.localghost.ai/countdown",
        "applicationCategory": "UtilityApplication",
        "operatingSystem": "Any",
        "author": {
            "@type": "Organization",
            "name": "LocalGhost.ai",
            "url": "https://www.localghost.ai"
        }
    }
    </script>
    
    <link rel="stylesheet" href="/css/base.css">
    <style>
        /* Layout */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: background 0.5s;
        }
        
        body.doom {
            background: linear-gradient(180deg, #1a0000 0%, #111 100%);
        }
        
        .container {
            text-align: center;
            padding: 2rem;
            position: relative;
            z-index: 10;
        }
        
        /* Typography */
        .label {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--terminal);
            letter-spacing: 0.3em;
            margin-bottom: 1rem;
            transition: color 0.5s;
        }
        
        body.doom .label {
            color: #ff4444;
        }
        
        .countdown {
            font-family: var(--font-mono);
            font-size: clamp(4rem, 15vw, 12rem);
            font-weight: 700;
            color: var(--terminal);
            text-shadow: 0 0 20px var(--terminal), 0 0 40px var(--terminal-dim);
            line-height: 1;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        body.doom .countdown {
            color: #ff6600;
            text-shadow: 0 0 20px #ff6600, 0 0 40px #ff0000;
        }
        
        .countdown.warning {
            color: var(--warning);
            text-shadow: 0 0 20px var(--warning), 0 0 40px #ff4444;
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        body.doom .countdown.warning {
            color: #ff0000;
            text-shadow: 0 0 30px #ff0000, 0 0 60px #990000;
            animation: doom-pulse 0.3s ease-in-out infinite;
        }
        
        .countdown.final {
            color: #fff;
            text-shadow: 0 0 30px #fff, 0 0 60px var(--terminal);
            animation: pulse 1s ease-in-out infinite;
        }
        
        body.doom .countdown.final {
            color: #ff0000;
            text-shadow: 0 0 40px #ff0000, 0 0 80px #ff6600, 0 0 120px #ffff00;
            animation: doom-pulse 0.2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes doom-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        .status {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            color: var(--text-dim);
            margin-top: 1rem;
            min-height: 2rem;
        }
        
        .status.alert {
            color: var(--warning);
            font-weight: 700;
        }
        
        body.doom .status.alert {
            color: #ff0000;
        }
        
        .status.complete {
            color: var(--terminal);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }
        
        body.doom .status.complete {
            color: #ff4444;
        }
        
        .target-time {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }
        
        /* Buttons */
        .btn {
            font-family: var(--font-mono);
            padding: 1rem 2rem;
            background: transparent;
            border: 2px solid var(--terminal);
            color: var(--terminal);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: var(--terminal);
            color: var(--void);
        }
        
        .btn.secondary {
            border-color: var(--text-dim);
            color: var(--text-dim);
        }
        
        .btn.secondary:hover {
            background: var(--text-dim);
            color: var(--void);
        }
        
        .btn.small {
            font-size: 0.7rem;
            padding: 0.5rem 1rem;
        }
        
        .btn.hidden { display: none; }
        
        .button-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }
        
        /* Form elements */
        .picker {
            margin-top: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            background: rgba(26, 26, 26, 0.8);
        }
        
        .picker.hidden { display: none; }
        
        .picker-label {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--terminal);
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: block;
        }
        
        body.doom .picker-label {
            color: #ff4444;
        }
        
        .picker-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .input {
            font-family: var(--font-mono);
            font-size: 1rem;
            padding: 0.5rem;
            background: var(--void);
            border: 1px solid var(--border);
            color: var(--text);
            outline: none;
        }
        
        .input:focus {
            border-color: var(--terminal);
        }
        
        body.doom .input:focus {
            border-color: #ff4444;
        }
        
        input[type="date"],
        input[type="time"] {
            color-scheme: dark;
        }
        
        /* Mode toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }
        
        .mode-toggle input[type="checkbox"] {
            display: none;
        }
        
        .toggle-track {
            width: 50px;
            height: 26px;
            background: var(--terminal);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-track::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--void);
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }
        
        .mode-toggle input:checked + .toggle-track {
            background: #ff4444;
        }
        
        .mode-toggle input:checked + .toggle-track::after {
            transform: translateX(24px);
        }
        
        .mode-label {
            color: var(--text-dim);
            transition: color 0.3s;
        }
        
        .mode-label.active {
            color: var(--terminal);
        }
        
        body.doom .mode-label.active {
            color: #ff4444;
        }
        
        /* Share link */
        .share-link {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 1rem;
            word-break: break-all;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .share-link.hidden { display: none; }
        
        .copy-btn {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--terminal);
            color: var(--terminal);
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .copy-btn:hover {
            background: var(--terminal);
            color: var(--void);
        }
        
        .note {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 1rem;
        }
        
        /* Effects container */
        .effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        /* Happy mode particles */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: particle-fly 1.5s ease-out forwards;
        }
        
        @keyframes particle-fly {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.5); }
        }
        
        .mega-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: mega-explode 2s ease-out forwards;
            box-shadow: 0 0 60px 30px #FFD700, 0 0 100px 60px #FF6B6B, 0 0 140px 90px #33FF00;
            z-index: 100;
        }
        
        @keyframes mega-explode {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(50); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(100); opacity: 0; }
        }
        
        /* Doom mode effects */
        .doom-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: doom-explode 3s ease-out forwards;
            box-shadow: 0 0 60px 30px #ff0000, 0 0 100px 60px #ff6600, 0 0 200px 100px #000;
            z-index: 100;
        }
        
        @keyframes doom-explode {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(80); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(150); opacity: 0; }
        }
        
        .shockwave {
            position: fixed;
            border: 4px solid #ff6600;
            border-radius: 50%;
            animation: shockwave 1.5s ease-out forwards;
        }
        
        @keyframes shockwave {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 200vmax; height: 200vmax; opacity: 0; }
        }
        
        .ember {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6600;
            border-radius: 50%;
            animation: ember-fall linear forwards;
            box-shadow: 0 0 6px 2px #ff4400;
        }
        
        @keyframes ember-fall {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100vh) scale(0.3); }
        }
        
        .crack {
            position: fixed;
            background: linear-gradient(90deg, transparent, #ff4400, transparent);
            height: 3px;
            animation: crack-spread 0.5s ease-out forwards;
            transform-origin: center;
        }
        
        @keyframes crack-spread {
            0% { width: 0; opacity: 1; }
            100% { width: 100vw; opacity: 0.3; }
        }
        
        /* Screen shake */
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -5px); }
            20% { transform: translate(10px, 5px); }
            30% { transform: translate(-5px, 10px); }
            40% { transform: translate(5px, -10px); }
            50% { transform: translate(-10px, 5px); }
            60% { transform: translate(10px, -5px); }
            70% { transform: translate(-5px, -10px); }
            80% { transform: translate(5px, 10px); }
            90% { transform: translate(-10px, -5px); }
        }
        
        body.shaking {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="label" id="eventLabel">&gt; COUNTDOWN</div>
        <div class="countdown" id="countdown">--:--:--</div>
        <div class="status" id="status">Set your target</div>
        <div class="target-time" id="target">Target: --</div>
        
        <div class="picker" id="picker">
            <span class="picker-label">&gt; CONFIGURE</span>
            
            <div class="picker-row">
                <input type="date" class="input" id="targetDate">
                <input type="time" class="input" id="targetTime" value="00:00">
            </div>
            
            <div class="picker-row">
                <input type="text" class="input" id="eventName" placeholder="Event name" style="width: 200px;">
            </div>
            
            <div class="picker-row">
                <div class="mode-toggle">
                    <span class="mode-label active" id="happyLabel">HAPPY</span>
                    <input type="checkbox" id="doomMode">
                    <label class="toggle-track" for="doomMode"></label>
                    <span class="mode-label" id="doomLabel">DOOM</span>
                </div>
            </div>
            
            <div class="share-link hidden" id="shareLink">
                <span id="shareLinkText"></span>
                <button class="copy-btn" id="copyBtn">COPY</button>
            </div>
        </div>
        
        <div class="button-row">
            <button class="btn" id="startBtn">[ START ]</button>
            <button class="btn secondary hidden" id="resetBtn">[ RESET ]</button>
        </div>
        
        <div class="button-row">
            <button class="btn small secondary" id="testBtn">[ TEST 35s ]</button>
            <button class="btn small secondary" id="testAudioBtn">[ TEST AUDIO ]</button>
            <button class="btn small secondary" id="testEffectsBtn">[ TEST EFFECTS ]</button>
        </div>
        
        <div class="note">âš  Audio requires interaction. Turn up volume.</div>
    </div>
    
    <div class="effects" id="effects"></div>
    
    <audio id="happyAudio" preload="auto">
        <source src="/assets/mp3/happy-new-year.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="doomAudio" preload="auto">
        <source src="/assets/mp3/o-fortuna.mp3" type="audio/mpeg">
    </audio>

    <script>
        // State
        let isRunning = false;
        let hasPlayedWarning = false;
        let hasTriggeredFinale = false;
        let testTarget = null;
        let doomMode = false;
        let customTarget = null;
        let eventName = '';
        let musicTimeout = null;
        let audioContext = null;
        
        const MUSIC_DURATION = 180000;
        
        // Elements
        const $ = id => document.getElementById(id);
        const body = document.body;
        const countdownEl = $('countdown');
        const statusEl = $('status');
        const targetEl = $('target');
        const eventLabelEl = $('eventLabel');
        const pickerEl = $('picker');
        const startBtn = $('startBtn');
        const resetBtn = $('resetBtn');
        const testBtn = $('testBtn');
        const effectsEl = $('effects');
        const dateInput = $('targetDate');
        const timeInput = $('targetTime');
        const nameInput = $('eventName');
        const doomToggle = $('doomMode');
        const happyLabel = $('happyLabel');
        const doomLabel = $('doomLabel');
        const shareLinkEl = $('shareLink');
        const shareLinkText = $('shareLinkText');
        const happyAudio = $('happyAudio');
        const doomAudio = $('doomAudio');
        
        // URL params
        function parseURL() {
            const params = new URLSearchParams(location.search);
            
            if (params.get('target')) {
                const d = new Date(params.get('target'));
                if (!isNaN(d)) {
                    customTarget = d;
                    const [date, time] = params.get('target').split('T');
                    dateInput.value = date;
                    if (time) timeInput.value = time.substring(0, 5);
                }
            }
            
            if (params.get('name')) {
                eventName = decodeURIComponent(params.get('name'));
                nameInput.value = eventName;
                eventLabelEl.textContent = `> ${eventName.toUpperCase()}`;
                document.title = `${eventName} | LocalGhost.ai`;
            }
            
            if (params.get('doom') === '1') {
                doomMode = true;
                doomToggle.checked = true;
                updateModeUI();
            }
            
            return !!params.get('target');
        }
        
        function generateShareURL() {
            if (!dateInput.value) return null;
            
            const base = location.origin + location.pathname;
            let url = `${base}?target=${dateInput.value}T${timeInput.value || '00:00'}`;
            if (nameInput.value) url += `&name=${encodeURIComponent(nameInput.value)}`;
            if (doomToggle.checked) url += '&doom=1';
            
            return url;
        }
        
        function updateShareLink() {
            const url = generateShareURL();
            if (url) {
                shareLinkText.textContent = url;
                shareLinkEl.classList.remove('hidden');
            } else {
                shareLinkEl.classList.add('hidden');
            }
        }
        
        const HAPPY_DEFAULT = 'Happy New Year';
        const DOOM_DEFAULT = 'End of Days';
        
        // Mode toggle
        function updateModeUI() {
            doomMode = doomToggle.checked;
            body.classList.toggle('doom', doomMode);
            happyLabel.classList.toggle('active', !doomMode);
            doomLabel.classList.toggle('active', doomMode);
            
            // Swap default names if user hasn't customized
            if (doomMode && nameInput.value === HAPPY_DEFAULT) {
                nameInput.value = DOOM_DEFAULT;
                eventLabelEl.textContent = `> ${DOOM_DEFAULT.toUpperCase()}`;
                document.title = `${DOOM_DEFAULT} | LocalGhost.ai`;
            } else if (!doomMode && nameInput.value === DOOM_DEFAULT) {
                nameInput.value = HAPPY_DEFAULT;
                eventLabelEl.textContent = `> ${HAPPY_DEFAULT.toUpperCase()}`;
                document.title = `${HAPPY_DEFAULT} | LocalGhost.ai`;
            }
            
            updateShareLink();
        }
        
        doomToggle.addEventListener('change', updateModeUI);
        
        // Set defaults
        function setDefaults() {
            const now = new Date();
            let year = now.getFullYear();
            
            // If we're past Jan 1 midnight, target next year
            const thisNYE = new Date(year + 1, 0, 1, 0, 0, 0);
            if (now >= thisNYE) year++;
            
            // Target Jan 1 00:00 (midnight)
            dateInput.value = `${year + 1}-01-01`;
            timeInput.value = '00:00';
            nameInput.value = HAPPY_DEFAULT;
            document.title = `${HAPPY_DEFAULT} | LocalGhost.ai`;
        }
        
        // Format helpers
        function formatTime(ms) {
            if (ms <= 0) return '00:00:00';
            
            const s = Math.floor(ms / 1000);
            const days = Math.floor(s / 86400);
            const hrs = Math.floor((s % 86400) / 3600);
            const mins = Math.floor((s % 3600) / 60);
            const secs = s % 60;
            
            const pad = n => n.toString().padStart(2, '0');
            
            if (days > 0) return `${days}d ${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
        }
        
        function formatTarget(d) {
            return d.toLocaleDateString('en-US', {
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        // Audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        function playTone(freq, duration, type = 'sine') {
            const ctx = initAudio();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = type;
            osc.frequency.value = freq;
            
            const now = ctx.currentTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now);
            osc.stop(now + duration);
        }
        
        function playWarning() {
            if (doomMode) {
                // Ominous low rumble
                [65.41, 82.41, 98.00].forEach((f, i) => {
                    setTimeout(() => playTone(f, 1.5, 'sawtooth'), i * 200);
                });
            } else {
                // Bright fanfare
                const notes = [392, 494, 587, 523, 659, 784];
                notes.forEach((f, i) => {
                    setTimeout(() => playTone(f, 0.3, 'triangle'), i * 100);
                });
            }
        }
        
        function playFinale() {
            const audio = doomMode ? doomAudio : happyAudio;
            audio.volume = 1.0;
            audio.currentTime = doomMode ? 0 : 44;
            
            audio.play().catch(() => {});
            
            if (musicTimeout) clearTimeout(musicTimeout);
            musicTimeout = setTimeout(() => audio.pause(), MUSIC_DURATION);
        }
        
        function playTick() {
            const freq = doomMode ? 100 : 800;
            playTone(freq, 0.1, doomMode ? 'sawtooth' : 'sine');
        }
        
        // Effects
        function createHappyEffects() {
            const colors = ['#33FF00', '#FF8A8A', '#FFFFFF', '#FFD700', '#00FFFF', '#FF00FF', '#FFA500'];
            
            // Center burst
            const burst = document.createElement('div');
            burst.className = 'mega-burst';
            effectsEl.appendChild(burst);
            setTimeout(() => burst.remove(), 2000);
            
            // Fireworks
            for (let b = 0; b < 25; b++) {
                setTimeout(() => {
                    const x = 10 + Math.random() * 80;
                    const y = 10 + Math.random() * 80;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    for (let i = 0; i < 30; i++) {
                        const p = document.createElement('div');
                        p.className = 'particle';
                        p.style.cssText = `left:${x}%;top:${y}%;background:${color};box-shadow:0 0 6px ${color}`;
                        
                        const angle = (Math.PI * 2 * i) / 30 + Math.random() * 0.5;
                        const dist = 80 + Math.random() * 100;
                        p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
                        p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
                        
                        effectsEl.appendChild(p);
                        setTimeout(() => p.remove(), 1500);
                    }
                }, b * 400);
            }
            
            // Sparkles for 20s
            const sparkle = setInterval(() => {
                for (let i = 0; i < 3; i++) {
                    const s = document.createElement('div');
                    s.className = 'particle';
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;background:${color}`;
                    s.style.setProperty('--tx', `${(Math.random()-0.5)*80}px`);
                    s.style.setProperty('--ty', `${(Math.random()-0.5)*80}px`);
                    effectsEl.appendChild(s);
                    setTimeout(() => s.remove(), 1500);
                }
            }, 150);
            setTimeout(() => clearInterval(sparkle), 20000);
        }
        
        function createDoomEffects() {
            // Screen shake
            body.classList.add('shaking');
            setTimeout(() => body.classList.remove('shaking'), 500);
            
            // Red burst
            const burst = document.createElement('div');
            burst.className = 'doom-burst';
            effectsEl.appendChild(burst);
            setTimeout(() => burst.remove(), 3000);
            
            // Shockwaves
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const sw = document.createElement('div');
                    sw.className = 'shockwave';
                    sw.style.cssText = `left:50%;top:50%;transform:translate(-50%,-50%)`;
                    effectsEl.appendChild(sw);
                    setTimeout(() => sw.remove(), 1500);
                    
                    // More shake
                    body.classList.add('shaking');
                    setTimeout(() => body.classList.remove('shaking'), 500);
                }, i * 800);
            }
            
            // Cracks
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const crack = document.createElement('div');
                    crack.className = 'crack';
                    crack.style.cssText = `top:${Math.random()*100}%;left:0;transform:rotate(${Math.random()*20-10}deg)`;
                    effectsEl.appendChild(crack);
                    setTimeout(() => crack.remove(), 3000);
                }, i * 200);
            }
            
            // Falling embers for 30s
            const embers = setInterval(() => {
                for (let i = 0; i < 5; i++) {
                    const e = document.createElement('div');
                    e.className = 'ember';
                    e.style.cssText = `left:${Math.random()*100}%;top:-10px;animation-duration:${2+Math.random()*3}s`;
                    effectsEl.appendChild(e);
                    setTimeout(() => e.remove(), 5000);
                }
            }, 100);
            setTimeout(() => clearInterval(embers), 30000);
        }
        
        // Main loop
        function getTarget() {
            if (testTarget) return testTarget;
            if (customTarget) return customTarget;
            
            // Default: next NYE midnight
            const now = new Date();
            const thisNYE = new Date(now.getFullYear() + 1, 0, 1, 0, 0, 0);
            return thisNYE;
        }
        
        function update() {
            if (!isRunning) return;
            
            const now = Date.now();
            const target = getTarget().getTime();
            const diff = target - now;
            const secs = Math.floor(diff / 1000);
            
            countdownEl.textContent = formatTime(diff);
            targetEl.textContent = testTarget ? 'TEST MODE' : `Target: ${formatTarget(getTarget())}`;
            
            // Warning at 30s
            if (secs <= 30 && secs > 10) {
                countdownEl.classList.add('warning');
                countdownEl.classList.remove('final');
                
                if (!hasPlayedWarning) {
                    hasPlayedWarning = true;
                    statusEl.textContent = doomMode ? 'âš  THE END APPROACHES âš ' : 'âš  30 SECONDS âš ';
                    statusEl.className = 'status alert';
                    playWarning();
                }
            }
            
            // Final 10s - tick each second
            if (secs <= 10 && secs > 0) {
                countdownEl.classList.remove('warning');
                countdownEl.classList.add('final');
                statusEl.textContent = secs.toString();
                statusEl.className = 'status alert';
                
                // Tick on each new second
                const msInSec = diff % 1000;
                if (msInSec > 900) playTick();
            }
            
            // Finale!
            if (secs <= 0 && !hasTriggeredFinale) {
                hasTriggeredFinale = true;
                countdownEl.textContent = '00:00:00';
                countdownEl.classList.add('final');
                
                const msg = eventName 
                    ? (doomMode ? `ðŸ’€ ${eventName.toUpperCase()} ðŸ’€` : `ðŸŽ‰ ${eventName.toUpperCase()}! ðŸŽ‰`)
                    : (doomMode ? 'ðŸ’€ IT IS DONE ðŸ’€' : 'ðŸŽ‰ TIME! ðŸŽ‰');
                statusEl.textContent = msg;
                statusEl.className = 'status complete';
                
                playFinale();
                doomMode ? createDoomEffects() : createHappyEffects();
                
                // Reset after celebration
                setTimeout(reset, MUSIC_DURATION + 2000);
            }
            
            requestAnimationFrame(update);
        }
        
        function start() {
            // Read inputs
            if (dateInput.value) {
                customTarget = new Date(`${dateInput.value}T${timeInput.value || '00:00'}`);
            }
            eventName = nameInput.value;
            if (eventName) {
                eventLabelEl.textContent = `> ${eventName.toUpperCase()}`;
                document.title = `${eventName} | LocalGhost.ai`;
            }
            
            initAudio();
            
            isRunning = true;
            hasPlayedWarning = false;
            hasTriggeredFinale = false;
            
            pickerEl.classList.add('hidden');
            startBtn.classList.add('hidden');
            testBtn.classList.add('hidden');
            resetBtn.classList.remove('hidden');
            statusEl.textContent = 'Running...';
            statusEl.className = 'status';
            countdownEl.classList.remove('warning', 'final');
            
            update();
        }
        
        function reset() {
            isRunning = false;
            hasPlayedWarning = false;
            hasTriggeredFinale = false;
            testTarget = null;
            
            if (musicTimeout) clearTimeout(musicTimeout);
            happyAudio.pause();
            doomAudio.pause();
            
            effectsEl.innerHTML = '';
            body.classList.remove('shaking');
            
            countdownEl.textContent = '--:--:--';
            countdownEl.classList.remove('warning', 'final');
            statusEl.textContent = 'Ready';
            statusEl.className = 'status';
            
            pickerEl.classList.remove('hidden');
            startBtn.classList.remove('hidden');
            testBtn.classList.remove('hidden');
            resetBtn.classList.add('hidden');
        }
        
        // Event listeners
        startBtn.addEventListener('click', start);
        resetBtn.addEventListener('click', reset);
        
        testBtn.addEventListener('click', () => {
            initAudio();
            testTarget = new Date(Date.now() + 35000);
            customTarget = null;
            
            isRunning = true;
            hasPlayedWarning = false;
            hasTriggeredFinale = false;
            
            pickerEl.classList.add('hidden');
            startBtn.classList.add('hidden');
            testBtn.classList.add('hidden');
            resetBtn.classList.remove('hidden');
            statusEl.textContent = 'TEST MODE - 35s';
            statusEl.className = 'status alert';
            countdownEl.classList.remove('warning', 'final');
            
            update();
        });
        
        $('testAudioBtn').addEventListener('click', () => {
            initAudio();
            playFinale();
        });
        
        $('testEffectsBtn').addEventListener('click', () => {
            effectsEl.innerHTML = '';
            doomMode ? createDoomEffects() : createHappyEffects();
        });
        
        $('copyBtn').addEventListener('click', () => {
            const url = generateShareURL();
            if (url) {
                navigator.clipboard.writeText(url).then(() => {
                    $('copyBtn').textContent = 'COPIED!';
                    setTimeout(() => $('copyBtn').textContent = 'COPY', 2000);
                });
            }
        });
        
        dateInput.addEventListener('change', updateShareLink);
        timeInput.addEventListener('change', updateShareLink);
        nameInput.addEventListener('input', () => {
            updateShareLink();
            // Update label and title as user types
            const name = nameInput.value || (doomMode ? DOOM_DEFAULT : HAPPY_DEFAULT);
            eventLabelEl.textContent = `> ${name.toUpperCase()}`;
            document.title = `${name} | LocalGhost.ai`;
        });
        
        // Init
        const hasURLTarget = parseURL();
        if (!hasURLTarget) {
            setDefaults();
            eventLabelEl.textContent = `> ${HAPPY_DEFAULT.toUpperCase()}`;
        }
        // If URL had doom=1 but no custom name, set doom default
        if (doomMode && !eventName) {
            nameInput.value = DOOM_DEFAULT;
            eventLabelEl.textContent = `> ${DOOM_DEFAULT.toUpperCase()}`;
            document.title = `${DOOM_DEFAULT} | LocalGhost.ai`;
        }
        updateShareLink();
        
        if (hasURLTarget) {
            statusEl.textContent = 'Click START to begin';
        }
    </script>
</body>
</html>